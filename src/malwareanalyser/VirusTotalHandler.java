package malwareanalyser;

import java.io.File;
import java.util.Collection;
import java.util.Set;

import org.apache.commons.codec.digest.DigestUtils;
import org.apache.commons.io.FileUtils;

import virustotalapi.ReportScan;
import virustotalapi.VirusTotal;

public class VirusTotalHandler {

	public static void CheckApkFiles(String sourceFolder) {
		// TODO Auto-generated method stub
		
		try {
			String reportFolderPath = FileHandler.createDirectory(sourceFolder, "reports"); 
			
			Collection<File> files = FileHandler.findFiles(sourceFolder,
					new String[] { Constants.APK_EXTENSION });

			String reportPath = reportFolderPath + File.separator + "virustotal_results.tsv";
			File reportFile = new File(reportPath);
			//FileUtils.deleteQuietly(reportFile);
			System.out.print("File Name" + Constants.TAB_CHAR
					+ "SHA256" + Constants.TAB_CHAR + "Detected"
					+ Constants.TAB_CHAR + "Undetected");
			FileUtils.write(reportFile, "File Name" + Constants.TAB_CHAR
					+ "SHA256" + Constants.TAB_CHAR + "Detected"
					+ Constants.TAB_CHAR + "Undetected", true);
			int count = 0;
			VirusTotal VT = new VirusTotal(FileHandler.readConfigValue(Constants.VIRUS_TOTAL_TOKEN_CONFIG));
			for (File file : files) {
				
				String apkReportFilePath = file.getParentFile().getAbsolutePath() + File.separator + "reports" + File.separator + file.getName().replace("apk","tsv"); 
				File apkReportFile = new File(apkReportFilePath);
				int detected = 0;
				int undetected = 0;

				byte[] data = FileUtils.readFileToByteArray(file);
				String sha256Hex = DigestUtils.sha256Hex(data);
				Set<ReportScan> reports = VT.ReportScan(sha256Hex);
				count++;
				// Output the details of each scan result from a vendor
				for (ReportScan report : reports) {
					if (report.getDetected().equals("true"))
						detected++;
					else
						undetected++;
					
					FileUtils.write(apkReportFile, "AV: "+report.getVendor()+" Detected: "+report.getDetected()+" Update: "+report.getUpdate()+" Malware Name: "+report.getMalwarename(),true);
				}
				System.out.print("\n" + file.getName() + Constants.TAB_CHAR
						+ sha256Hex + Constants.TAB_CHAR + detected
						+ Constants.TAB_CHAR + undetected);
				FileUtils.write(reportFile, "\n" + file.getName()
						+ Constants.TAB_CHAR + sha256Hex + Constants.TAB_CHAR
						+ detected + Constants.TAB_CHAR + undetected, true);

				if (count % 4 == 0)
					Thread.sleep(61000);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

}
