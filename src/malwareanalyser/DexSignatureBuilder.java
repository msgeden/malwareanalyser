package malwareanalyser;

import org.apache.commons.codec.digest.DigestUtils;

import com.juliasoft.amalia.dex.file.AnnotationsDirectoryItem;
import com.juliasoft.amalia.dex.file.DexClass;
import com.juliasoft.amalia.dex.file.DexContext;
import com.juliasoft.amalia.dex.file.DexFile;
import com.juliasoft.amalia.dex.file.Field;
import com.juliasoft.amalia.dex.file.Method;
import com.juliasoft.amalia.dex.file.visit.DexFileVisitor;

public class DexSignatureBuilder implements DexFileVisitor {

	private DexContext context;
	private StringBuilder sb;
	private StringBuilder sbClass;

	@Override
	public void visitEnter(DexClass arg0) {
		// TODO Auto-generated method stub
		// System.out.println("ClassEnter");
		sbClass = new StringBuilder();
		String interfacesStr = "";
		if (arg0.getInterfaceList() != null
				&& arg0.getInterfaceList().size() > 0) {
			interfacesStr = " implements ";
			Object[] interfaces = arg0.getInterfaceList().toArray();
			for (int i = 0; i < interfaces.length; i++) {
				if (i != 0)
					interfacesStr += "," + interfaces[i].toString();
				else
					interfacesStr += interfaces[i].toString();
			}
		}
		// System.out.print("C:    " + context.getType(arg0.getTypeIdx()) +
		// " extends " + context.getType(arg0.getSuperclassIdx()) +
		// interfacesStr+ "\n");
		sb.append("C:    " + context.getType(arg0.getTypeIdx()) + " extends "
				+ context.getType(arg0.getSuperclassIdx()) + interfacesStr
				+ "\n");
		sbClass.append("C:    " + context.getType(arg0.getTypeIdx())
				+ " extends " + context.getType(arg0.getSuperclassIdx())
				+ interfacesStr + "\n");
	}

	@Override
	public void visitEnter(Method arg0) {
		// TODO Auto-generated method stub
		// System.out.println("MethodEnter");
		// System.out.print("\tM:    " +
		// context.getString(context.getMethodId(arg0.getIndex()).getName_idx())
		// +
		// context.getProto(context.getMethodId(arg0.getIndex()).getProto_idx()).toHuman()+
		// "\n");
		sb.append("\tM:    "
				+ context.getString(context.getMethodId(arg0.getIndex())
						.getName_idx())
				+ context.getProto(
						context.getMethodId(arg0.getIndex()).getProto_idx())
						.toHuman() + "\n");
		sbClass.append("\tM:    "
				+ context.getString(context.getMethodId(arg0.getIndex())
						.getName_idx())
				+ context.getProto(
						context.getMethodId(arg0.getIndex()).getProto_idx())
						.toHuman() + "\n");

	}

	@Override
	public void visitEnter(Field arg0) {
		// TODO Auto-generated method stub
		// System.out.println("FieldEnter");
		// System.out.print("\tF:    " +
		// context.getType(context.getFieldId(arg0.getIndex()).getType_idx()).toHuman()
		// + " " +
		// context.getString(context.getFieldId(arg0.getIndex()).getName_idx())+
		// "\n");
		sb.append("\tF:    "
				+ context.getType(
						context.getFieldId(arg0.getIndex()).getType_idx())
						.toHuman()
				+ " "
				+ context.getString(context.getFieldId(arg0.getIndex())
						.getName_idx()) + "\n");
		sbClass.append("\tF:    "
				+ context.getType(
						context.getFieldId(arg0.getIndex()).getType_idx())
						.toHuman()
				+ " "
				+ context.getString(context.getFieldId(arg0.getIndex())
						.getName_idx()) + "\n");
	}

	@Override
	public void visitEnter(AnnotationsDirectoryItem arg0) {
		// TODO Auto-generated method stub
		// System.out.println("AnnotationDirectoryEnter");

	}

	@Override
	public void visitLeave(DexClass arg0) {
		// TODO Auto-generated method stub
		// System.out.println("ClassLeave");
		String md5 = new String(DigestUtils.md5Hex(sbClass.toString()));
		sb.append("H:    " + md5 + "\n\n");

	}

	@Override
	public void visitLeave(Method arg0) {
		// TODO Auto-generated method stub
		// System.out.println("MethodLeave");

	}

	@Override
	public void visitLeave(Field arg0) {
		// TODO Auto-generated method stub
		// System.out.println("FieldLeave");

	}

	@Override
	public void visitLeave(AnnotationsDirectoryItem arg0) {
		// TODO Auto-generated method stub
		// System.out.println("AnnotationDirectoryItemLeave");

	}

	@Override
	public void visitEnter(DexFile arg0) {
		// TODO Auto-generated method stub
		// System.out.println("FileEnter");
		sb = new StringBuilder();
	}

	@Override
	public void visitEnter(DexContext arg0) {
		// TODO Auto-generated method stub
		context = arg0;
		// System.out.println("ContextEnter");
	}

	@Override
	public void visitEnter(DexClass[] arg0) {
		// TODO Auto-generated method stub
		// System.out.println("ClassArrayEnter");
	}

	@Override
	public void visitLeave(DexFile arg0) {
		// TODO Auto-generated method stub
		// System.out.println("FileLeave");
	}

	@Override
	public void visitLeave(DexContext arg0) {
		// TODO Auto-generated method stub
		// System.out.println("ContextLeave");
	}

	@Override
	public void visitLeave(DexClass[] arg0) {
		// TODO Auto-generated method stub
		// System.out.println("ClassArrayLeave");
	}

	public String getSignature() {
		return sb.toString();
	}

}
